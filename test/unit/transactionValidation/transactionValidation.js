/* eslint-disable max-len */
const assert = require('assert')
const InteropLib = require('cardano-hw-interop-lib')
const { checkValidationErrors } = require('../../../src/transaction/transactionValidation')

const rawTransactions = {
  validSimple: {
    rawTxCborHex: '83a40081825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b0001818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f9ffff6',
    validationResult: {
      containsFixable: false,
      containsUnfixable: false,
    },
    transformedRawTxCborHex: '83a40081825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b0001818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f9ffff6',
  },
  validComplex: {
    rawTxCborHex: '83a60082825820169422f7193e3418318c2420590778e68619119403472f70c0bb9e9feb2b457100825820cba5f1dd03010380d5c1a6471e7223ac48a7baf75c76e3824896d4398fe0155e000183825839306665c42b15b35c7937381bd545c5e7b6b3a03a24cf0383d409ac4583381f757b787201d66ae47603d1abd06ceaa031188e923568c937e8bc821a27aa98ffa1581c13a36080b2263de3bf122d69f680eff37f8f640dac951e6048abd664a1444b6f6a6e1a000927c082583930de685e72586c4269087e282c9c7e78ba22082bce4a674977b4000e99b494d35f236093e7caed75d2b99b1e523cde935a6f4a2d276b9fb401821a27aa98ffa1581c13a36080b2263de3bf122d69f680eff37f8f640dac951e6048abd664a1444b6f6a6e1a00061a80825839000743d16cfe3c4fcc0c11c2403bbc10dbc7ecdd4477e053481a368e7a06e2ae44dff6770dc0f4ada3cf4cf2605008e27aecdb332ad349fda71a27aa98fe021a0003ba51048182018201581cb494d35f236093e7caed75d2b99b1e523cde935a6f4a2d276b9fb40105a1581df0381f757b787201d66ae47603d1abd06ceaa031188e923568c937e8bc0009a1581c13a36080b2263de3bf122d69f680eff37f8f640dac951e6048abd664a1444b6f6a6e1a000f42409f8200581c9a70dd7c77e9db9442b560a11446962e9d7c595274c587a62f8a0b618201828200581c9205690f6ea4b76742c6bdc5b79fb8a1727260089c71a64c7275320e8200581c3d926054e17d9ed8374d0e1d18c765209dd0c249f954214c45417fea8200581cf699c6400f85bdca54e44d0cad1f6141ce049a411c0d695fc30c3f738201828200581cf699c6400f85bdca54e44d0cad1f6141ce049a411c0d695fc30c3f738200581c4c139dd7e3a600fd1a4855b38cf8f731f39d3051791a5ede1f553d6c8201828200581c43040068ce85252be6164296d6dca9595644bbf424b56b74244582278200581c46b9d3c2f37b1013265f6abf21400f0e4cf21ddb2088bfe58058e1cafff6',
    validationResult: {
      containsFixable: false,
      containsUnfixable: false,
    },
    transformedRawTxCborHex: '83a60082825820169422f7193e3418318c2420590778e68619119403472f70c0bb9e9feb2b457100825820cba5f1dd03010380d5c1a6471e7223ac48a7baf75c76e3824896d4398fe0155e000183825839306665c42b15b35c7937381bd545c5e7b6b3a03a24cf0383d409ac4583381f757b787201d66ae47603d1abd06ceaa031188e923568c937e8bc821a27aa98ffa1581c13a36080b2263de3bf122d69f680eff37f8f640dac951e6048abd664a1444b6f6a6e1a000927c082583930de685e72586c4269087e282c9c7e78ba22082bce4a674977b4000e99b494d35f236093e7caed75d2b99b1e523cde935a6f4a2d276b9fb401821a27aa98ffa1581c13a36080b2263de3bf122d69f680eff37f8f640dac951e6048abd664a1444b6f6a6e1a00061a80825839000743d16cfe3c4fcc0c11c2403bbc10dbc7ecdd4477e053481a368e7a06e2ae44dff6770dc0f4ada3cf4cf2605008e27aecdb332ad349fda71a27aa98fe021a0003ba51048182018201581cb494d35f236093e7caed75d2b99b1e523cde935a6f4a2d276b9fb40105a1581df0381f757b787201d66ae47603d1abd06ceaa031188e923568c937e8bc0009a1581c13a36080b2263de3bf122d69f680eff37f8f640dac951e6048abd664a1444b6f6a6e1a000f42409f8200581c9a70dd7c77e9db9442b560a11446962e9d7c595274c587a62f8a0b618201828200581c9205690f6ea4b76742c6bdc5b79fb8a1727260089c71a64c7275320e8200581c3d926054e17d9ed8374d0e1d18c765209dd0c249f954214c45417fea8200581cf699c6400f85bdca54e44d0cad1f6141ce049a411c0d695fc30c3f738201828200581cf699c6400f85bdca54e44d0cad1f6141ce049a411c0d695fc30c3f738200581c4c139dd7e3a600fd1a4855b38cf8f731f39d3051791a5ede1f553d6c8201828200581c43040068ce85252be6164296d6dca9595644bbf424b56b74244582278200581c46b9d3c2f37b1013265f6abf21400f0e4cf21ddb2088bfe58058e1cafff6',
  },
  fixableIndefiniteLengthArray: {
    rawTxCborHex: '83a4009f825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b00ff01818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f9ffff6',
    validationResult: {
      containsFixable: true,
      containsUnfixable: false,
    },
    transformedRawTxCborHex: '83a40081825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b0001818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f9ffff6',
  },
  fixableEmptyOptionalArray: {
    rawTxCborHex: '83a50081825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b0001818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f04809ffff6',
    validationResult: {
      containsFixable: true,
      containsUnfixable: false,
    },
    transformedRawTxCborHex: '83a40081825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b0001818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f9ffff6',
  },
  fixableWrongOrder: {
    rawTxCborHex: '83a500818258205ecbc2e3779c88ef83193e0788bd0ca3ee8e839695736ca2bd1a0d5d17c74d660001818258390074976c54afaf444f7cd499bd8519aac6592b13b22b9d5817f0da5c5203d205532089ad2f7816892e2ef42849b7b52788e41b3fd43a6e01cf821b000000e8d4c51c9ba1581c2e2f143b3ccbe339145183dc2a799a469e92ab56e0d5b0bd04f54f15a34018644611223322110018c84568616c6c6f19012c021a0002cc9d031a029b6d6f09a1581c2e2f143b3ccbe339145183dc2a799a469e92ab56e0d5b0bd04f54f15a14568616c6c6f19012c9f8200581c344e624c22c7ee61264c4307591913c63adf36495b1fec6fdc5670cefff6',
    validationResult: {
      containsFixable: true,
      containsUnfixable: false,
    },
    transformedRawTxCborHex: '83a500818258205ecbc2e3779c88ef83193e0788bd0ca3ee8e839695736ca2bd1a0d5d17c74d660001818258390074976c54afaf444f7cd499bd8519aac6592b13b22b9d5817f0da5c5203d205532089ad2f7816892e2ef42849b7b52788e41b3fd43a6e01cf821b000000e8d4c51c9ba1581c2e2f143b3ccbe339145183dc2a799a469e92ab56e0d5b0bd04f54f15a34018644568616c6c6f19012c4611223322110018c8021a0002cc9d031a029b6d6f09a1581c2e2f143b3ccbe339145183dc2a799a469e92ab56e0d5b0bd04f54f15a14568616c6c6f19012c9f8200581c344e624c22c7ee61264c4307591913c63adf36495b1fec6fdc5670cefff6',
  },
  unfixableUnsupportedItem: {
    rawTxCborHex: '83a50081825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b0001818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f061a01a3bd8f9ffff6',
    validationResult: {
      containsFixable: false,
      containsUnfixable: true,
    },
    transformedRawTxCborHex: '83a50081825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b0001818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f061a01a3bd8f9ffff6',
  },
  fixableAndUnfixable: {
    rawTxCborHex: '83a60081825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b0001818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f0480061a01a3bd8f9ffff6',
    validationResult: {
      containsFixable: true,
      containsUnfixable: true,
    },
    transformedRawTxCborHex: '83a50081825820bc8bf52ea894fb8e442fe3eea628be87d0c9a37baef185b70eb00a5c8a849d3b0001818258390180f9e2c88e6c817008f3a812ed889b4a4da8e0bd103f86e7335422aa122a946b9ad3d2ddf029d3a828f0468aece76895f15c9efbd69b42771a0023583c021a00029b75031a01a3bd8f061a01a3bd8f9ffff6',
  },
}

function testValidateRaw(rawTx) {
  const rawTxCbor = Buffer.from(rawTx.rawTxCborHex, 'hex')
  const validationResult = checkValidationErrors(rawTxCbor, InteropLib.validateRawTx, false, false)
  assert.deepStrictEqual(validationResult, rawTx.validationResult)
}

function testTransformRaw(rawTx) {
  const rawTxCbor = Buffer.from(rawTx.rawTxCborHex, 'hex')
  const transformedRawTxCbor = InteropLib.encodeRawTx(InteropLib.transformRawTx(InteropLib.decodeRawTx(rawTxCbor)))
  assert.deepStrictEqual(transformedRawTxCbor.toString('hex'), rawTx.transformedRawTxCborHex)
}

describe('Validate and transform', () => {
  describe('Validate RawTx', () => {
    Object.entries(rawTransactions).forEach(([name, rawTx]) => it(
      `Should validate rawTx ${name}`,
      () => testValidateRaw(rawTx),
    ))
  })

  describe('Transform RawTx', () => {
    Object.entries(rawTransactions).forEach(([name, rawTx]) => it(
      `Should transform rawTx ${name}`,
      () => testTransformRaw(rawTx),
    ))
  })
})
